name: C Build CI

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential make
    
    - name: Show directory structure
      run: |
        echo "Current directory:"
        pwd
        echo "\nDirectory contents:"
        ls -la
        echo "\nInclude directory:"
        ls -la include/ || echo "include/ not found"
        echo "\nSrc directory:"
        ls -la src/ || echo "src/ not found"
    
    - name: Build with Make
      run: make
    
    - name: Show build results
      run: |
        echo "Build artifacts:"
        ls -la bin/ || echo "bin/ not found"
        ls -la obj/ || echo "obj/ not found"
        file bin/run || echo "Executable not found"

    - name: Run program with full test
      run: |
        echo "Running program with complete test..."
        cat > test_input.txt << 'EOF'
        1              # Ввод абонентов
        3              # 3 абонента
        Ivanov I.I.    # Абонент 1
        123-45-67
        2010 5 15
        Basic
        500
        450
        Petrov P.P.    # Абонент 2
        234-56-78
        2015 3 20
        Premium
        1000
        800
        Sidorov S.S.   # Абонент 3
        345-67-89
        2020 1 10
        Basic
        300
        250
        2              # Сортировка
        6              # Показать всех
        3              # Добавить бонус
        4              # Показать отрицательный баланс
        5              # Статистика тарифов
        0              # Выход
        EOF
        ./bin/run < test_input.txt
    
    - name: Clean build
      run: make clean
